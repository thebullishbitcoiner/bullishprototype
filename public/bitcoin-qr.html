<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="bootstrap-5.3.3/css/bootstrap.min.css" />
    <title>Bitcoin QR - Bullish Prototype</title>
    <script type="module" src="https://unpkg.com/bitcoin-qr@1.1.4/dist/bitcoin-qr/bitcoin-qr.esm.js"></script>
    <style>
        body {
            margin: 0;
        }

        .lightning {
            position: fixed;
            top: -50;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            z-index: 1000;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div id="navbar"></div>
    
        <div class="p-2">
            <h3 id="header">&lt;bitcoin-qr /&gt;</h3>
            <p>"A zero-dependency, zero-framework QR code web component for Bitcoin on-chain, Lightning, and unified BIP-21 payments."</p>
            <p>View on <a href="https://github.com/thebrandonlucas/bitcoin-qr">GitHub</a></p>
    
            <div class="flex flex-col items-center">
                <bitcoin-qr id="qr" width="350" height="350" lightning="lnbc..." is-polling="false" poll-interval="3000"
                    image="./images/thebullishbitcoiner.png" image-hide-background-dots="false" type="svg"
                    corners-square-color="#000" corners-dot-color="#ff9900" corners-square-type="square" dots-type="square"
                    dots-color="#000" debug="true" />
            </div>
    
            <div class="d-flex align-items-center w-100 pt-3">
                <input type="number" id="amount" class="form-control me-2 rounded-0" placeholder="Enter amount of sats"
                    style="flex: 1;" />
                <button id="create-invoice" class="btn rounded-0" style="background-color: #ff9900; color: #000;">Create invoice</button>
            </div>
    
            <div class="flex flex-col gap-2 w-100 pt-3">
                <textarea id="invoice" class="w-100 rounded-0" rows="7" readonly></textarea>
                <span id="paid">Paid: NO</span>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JavaScript -->
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"
        integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ"
        crossorigin="anonymous"></script>
    <script src="bootstrap-5.3.3/js/bootstrap.min.js"></script>
    <script type="module" src="js/common.js"></script>
    <script type="module">
        import { LightningAddress } from "https://esm.sh/@getalby/lightning-tools@5.1.2";

        let lightningInvoice;
        let paid;

        async function checkPayment() {
            if (!paid) {
                paid = await lightningInvoice.verifyPayment();
                if (paid && lightningInvoice.preimage) {
                    const qr = document.getElementById('qr');
                    qr.setAttribute('is-polling', false);

                    simulateLightning();

                    console.log(`Preimage: ${lightningInvoice.preimage}`);
                    document.getElementById('paid').innerText = `Paid: YESTR`;
                }
            }
        }

        async function getNewInvoice(sats = 21) {
            try {
                const ln = new LightningAddress('thebullishbitcoiner@getalby.com');
                await ln.fetch();

                var textarea = document.getElementById('invoice');
                textarea.value = "Generating invoice...";

                lightningInvoice = await ln.requestInvoice({ satoshi: sats });
                textarea.value = lightningInvoice.paymentRequest;

                const qr = document.getElementById('qr');
                qr.setAttribute('lightning', lightningInvoice.paymentRequest);
                qr.setAttribute('is-polling', true);

                document.getElementById('paid').innerText = `Paid: NO`;
            } catch (error) {
                alert("Failed to fetch invoice. Operation timed out.");
                return;
            }
        }

        // Function to copy text from the textarea to the clipboard
        document.getElementById('invoice').addEventListener('click', function () {
            this.select();
            this.setSelectionRange(0, 99999); // For mobile devices

            navigator.clipboard.writeText(this.value)
                .then(() => {
                    alert('Invoice copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                });
        });

        document.getElementById('header').addEventListener('click', function () {
            //simulateLightning();
        });

        const lightningImages = [
            'images/lightning1.png',
            'images/lightning2.png',
            'images/lightning3.png',
            'images/lightning4.png',
            'images/lightning5.png',
            'images/lightning6.png',
            'images/lightning7.png',
            'images/lightning8.png',
        ];

        function simulateLightning() {
            const numberOfLightnings = 2; // Number of lightning images to show
            const lightningElements = []; // Array to hold lightning elements

            for (let i = 0; i < numberOfLightnings; i++) {
                const lightning = document.createElement('img');
                lightning.src = lightningImages[Math.floor(Math.random() * lightningImages.length)];
                lightning.className = 'lightning';

                document.body.appendChild(lightning);
                lightningElements.push(lightning);

                setTimeout(() => {
                    lightning.style.opacity = 1; // Fade in
                }, 10);

                setTimeout(() => {
                    lightning.style.opacity = 0; // Fade out
                    setTimeout(() => {
                        document.body.removeChild(lightning);
                    }, 500);
                }, 500);
            }

            lightningElements.sort(() => Math.random() - 0.5);
        }

        document.getElementById('qr').callback = checkPayment;

        // Add event listener for the "Create invoice" button
        document.getElementById('create-invoice').addEventListener('click', function () {
            const amountInput = document.getElementById('amount');
            const sats = parseInt(amountInput.value, 10);
            if (isNaN(sats) || sats <= 0) {
                alert("Please enter a valid amount of sats.");
                return;
            }
            getNewInvoice(sats);
        });
    </script>
</body>

</html>