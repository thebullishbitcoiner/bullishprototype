<html lang="en" data-bs-theme="dark">

<head>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="bootstrap-5.3.3/css/bootstrap.min.css" />
    <title>Bitcoin QR</title>
    <script type="module" src="https://unpkg.com/bitcoin-qr@1.1.4/dist/bitcoin-qr/bitcoin-qr.esm.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        .lightning {
            position: absolute;
            width: 100px;
            /* Adjust size as needed */
            height: auto;
            pointer-events: none;
            /* Prevent interaction */
            opacity: 0;
            /* Start invisible */
            transition: opacity 0.2s ease-in-out;
            /* Smooth fade-in/out */
        }
    </style>
</head>

<body>

    <div class="container-fluid">

        <nav class="navbar navbar-expand-lg bg-body-tertiary">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">Bullish Prototype</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                    aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                        <li class="nav-item"><a class="nav-link" href="twentyuno.html">TwentyUno</a></li>
                        <li class="nav-item"><a class="nav-link" href="bitcoin-connect.html">Bitcoin Connect</a></li>
                        <li class="nav-item"><a class="nav-link active" href="bitcoin-qr.html">Bitcoin QR</a></li>
                        <li class="nav-item"><a class="nav-link" href="ocr.html">OCR</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <br>

        <h3>&lt;bitcoin-qr /&gt;</h3>
        <p>"A zero-dependency, zero-framework QR code web component for Bitcoin on-chain, Lightning, and unified BIP-21
            payments."</p>
        <p>View on <a href="https://github.com/thebrandonlucas/bitcoin-qr">GitHub</a></p>

        <div class="flex flex-col items-center">

            <bitcoin-qr id="qr" width="360" height="360" lightning="lnbc..." is-polling="false" poll-interval="3000"
                image="./images/thebullishbitcoiner-1.0.png" type="svg" corners-square-color="#000"
                corners-dot-color="#ff9900" corners-square-type="square" dots-type="square" dots-color="#000"
                debug="true" />

        </div>

        <div class="flex flex-col gap-2 w-100 pt-3">
            <textarea id="invoice" class="w-100" rows="7" readonly></textarea>
            <span id="paid">Paid: NO</span>
        </div>

    </div>

</body>

<script type="module">

    import { LightningAddress } from "https://esm.sh/@getalby/lightning-tools@5.0.0"; // jsdelivr.net, skypack.dev also work

    let lightningInvoice;

    async function checkPayment() {
        const paid = await lightningInvoice.verifyPayment();
        if (paid && lightningInvoice.preimage) {
            const qr = document.getElementById('qr');
            qr.setAttribute('is-polling', false);

            simulateLightning();

            console.log(`Preimage: ${lightningInvoice.preimage}`);
            document.getElementById('paid').innerText = `Paid: YES (refresh to get another invoice)`;
        }
    }

    async function getNewInvoice(sats = 21) {
        try {
            const ln = new LightningAddress('bullish@getalby.com');
            await ln.fetch();
            lightningInvoice = await ln.requestInvoice({ satoshi: sats });

            var textarea = document.getElementById('invoice');
            textarea.value = lightningInvoice.paymentRequest;

            const qr = document.getElementById('qr');
            qr.setAttribute('lightning', lightningInvoice.paymentRequest);
            qr.setAttribute('is-polling', true);

            document.getElementById('paid').innerText = `Paid: NO`;
        } catch (error) {
            alert("Failed to fetch invoice. Operation timed out.");
            return;
        }
    }

    // Function to copy text from the textarea to the clipboard
    document.getElementById('invoice').addEventListener('click', function () {
        // Select the text in the textarea
        this.select();
        this.setSelectionRange(0, 99999); // For mobile devices

        // Copy the text to the clipboard
        navigator.clipboard.writeText(this.value)
            .then(() => {
                alert('Invoice copied to clipboard!');
            })
            .catch(err => {
                console.error('Failed to copy: ', err);
            });
    });

    const lightningImages = [
            '/images/lightning.png', // Replace with your image paths
            '/images/lightning2.png',
            '/images/lightning3.png',
            // Add more images as needed
        ];

    function simulateLightning() {
        // Create a new image element
        const lightning = document.createElement('img');
        lightning.src = lightningImages[Math.floor(Math.random() * lightningImages.length)];
        lightning.className = 'lightning';

        // Set random position
        lightning.style.left = Math.random() * window.innerWidth + 'px';
        lightning.style.top = Math.random() * window.innerHeight + 'px';

        // Append to body
        document.body.appendChild(lightning);

        // Trigger the lightning effect
        setTimeout(() => {
            lightning.style.opacity = 1; // Fade in
        }, 10); // Small delay to ensure the image is rendered

        // Remove the lightning after a short duration
        setTimeout(() => {
            lightning.style.opacity = 0; // Fade out
            setTimeout(() => {
                document.body.removeChild(lightning); // Remove from DOM
            }, 200); // Wait for fade-out transition
        }, 200); // Duration of the lightning effect
    }

    document.getElementById('qr').callback = checkPayment;

    window.onload = getNewInvoice();

</script>

</html>