<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="bootstrap-5.3.3/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/dark-theme.css" />
    <title>Bitcoin QR - bullishPrototype</title>
    <script type="module" src="https://unpkg.com/bitcoin-qr@1.1.4/dist/bitcoin-qr/bitcoin-qr.esm.js"></script>
    <style>
        body {
            margin: 0;
        }

        .lightning {
            position: fixed;
            top: -50;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            z-index: 1000;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <div id="navbar"></div>

    <div id="main-content" class="container">
        <br>
        
        <div class="p-3 mb-4 bg-body-tertiary rounded-3">
            <div class="container-fluid py-3">
                <h1 class="display-6 fw-bold">&lt;bitcoin-qr /&gt;</h1>
                <p class="fs-5">"A zero-dependency, zero-framework QR code web component for Bitcoin on-chain, Lightning, and unified BIP-21 payments."</p>
                <p>View on <a href="https://github.com/thebrandonlucas/bitcoin-qr">GitHub</a></p>
            </div>
        </div>

            <div class="flex flex-col items-center">
                <bitcoin-qr id="qr" width="350" height="350" lightning="lnbc..." is-polling="false" poll-interval="3000"
                    image="./images/thebullishbitcoiner.png" image-hide-background-dots="false" type="svg"
                    corners-square-color="#000" corners-dot-color="#ff9900" corners-square-type="square"
                    dots-type="square" dots-color="#000" debug="true" />
            </div>

            <div class="d-flex align-items-center w-100 pt-3">
                <input type="number" id="amount" class="form-control me-2 rounded-0" placeholder="Enter amount of sats"
                    style="flex: 1;" />
                <button id="create-invoice" class="btn rounded-0" style="background-color: #ff9900; color: #000;">Create
                    invoice</button>
            </div>

            <div class="flex flex-col gap-2 w-100 pt-3">
                <textarea id="invoice" class="w-100 rounded-0" rows="7" readonly></textarea>
                <span id="paid">Paid: NO</span>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JavaScript -->
    <script src="bootstrap-5.3.3/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="js/main.jsx"></script>
    <script type="module">
        import { LightningAddress } from "@getalby/lightning-tools";
        import { LIGHTNING_ADDRESSES, DEFAULTS } from "./js/config.js";

        let lightningInvoice;
        let paid;

        // Helper function to show error messages
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Helper function to show success messages
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        async function checkPayment() {
            if (!paid) {
                paid = await lightningInvoice.verifyPayment();
                if (paid && lightningInvoice.preimage) {
                    const qr = document.getElementById('qr');
                    qr.setAttribute('is-polling', false);

                    simulateLightning();

                    console.log(`Preimage: ${lightningInvoice.preimage}`);
                    document.getElementById('paid').innerText = `Paid: YESTR`;
                }
            }
        }

        async function getNewInvoice(sats = DEFAULTS.INVOICE_AMOUNT) {
            try {
                const ln = new LightningAddress(LIGHTNING_ADDRESSES.PRIMARY);
                await ln.fetch();

                var textarea = document.getElementById('invoice');
                textarea.value = "Generating invoice...";

                lightningInvoice = await ln.requestInvoice({ satoshi: sats });
                textarea.value = lightningInvoice.paymentRequest;

                const qr = document.getElementById('qr');
                qr.setAttribute('lightning', lightningInvoice.paymentRequest);
                qr.setAttribute('is-polling', true);

                document.getElementById('paid').innerText = `Paid: NO`;
            } catch (error) {
                showError(`Failed to fetch invoice: ${error.message || 'Operation timed out'}`);
                console.error('Invoice creation error:', error);
                return;
            }
        }

        // Function to copy text from the textarea to the clipboard
        document.getElementById('invoice').addEventListener('click', function () {
            this.select();
            this.setSelectionRange(0, 99999); // For mobile devices

            navigator.clipboard.writeText(this.value)
                .then(() => {
                    showSuccess('Invoice copied to clipboard!');
                })
                .catch(err => {
                    showError('Failed to copy invoice to clipboard');
                    console.error('Failed to copy: ', err);
                });
        });

        document.getElementById('header').addEventListener('click', function () {
            //simulateLightning();
        });

        const lightningImages = [
            'images/lightning1.png',
            'images/lightning2.png',
            'images/lightning3.png',
            'images/lightning4.png',
            'images/lightning5.png',
            'images/lightning6.png',
            'images/lightning7.png',
            'images/lightning8.png',
        ];

        function simulateLightning() {
            const numberOfLightnings = 2; // Number of lightning images to show
            const lightningElements = []; // Array to hold lightning elements

            for (let i = 0; i < numberOfLightnings; i++) {
                const lightning = document.createElement('img');
                lightning.src = lightningImages[Math.floor(Math.random() * lightningImages.length)];
                lightning.className = 'lightning';

                document.body.appendChild(lightning);
                lightningElements.push(lightning);

                setTimeout(() => {
                    lightning.style.opacity = 1; // Fade in
                }, 10);

                setTimeout(() => {
                    lightning.style.opacity = 0; // Fade out
                    setTimeout(() => {
                        document.body.removeChild(lightning);
                    }, 500);
                }, 500);
            }

            lightningElements.sort(() => Math.random() - 0.5);
        }

        document.getElementById('qr').callback = checkPayment;

        // Add event listener for the "Create invoice" button
        document.getElementById('create-invoice').addEventListener('click', function () {
            const amountInput = document.getElementById('amount');
            const sats = parseInt(amountInput.value, 10);
            if (isNaN(sats) || sats <= 0) {
                showError('Please enter a valid amount of sats');
                return;
            }
            getNewInvoice(sats);
        });
    </script>
</body>

</html>